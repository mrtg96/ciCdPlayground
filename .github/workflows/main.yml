name: CI

on: 
  push:
  pull_request:
  workflow_dispatch:
    inputs:
      version:
        description: "Specify the Tag here"
        required: false
        type: string
  
permissions:
  checks: write
  pull-requests: write
  id-token: write
  contents: write
  pages: write

jobs:
  tag:
    if: ${{ inputs.version != '' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Create and push tag
        run: |
          TAG="v${{ inputs.version }}"
          git fetch --tags
          if git rev-parse -q --verify "refs/tags/$TAG" >/dev/null; then
            echo "Tag $TAG already exists; skipping."
            exit 0
          fi
          git tag "$TAG"
          git push origin "$TAG"
  build:
    runs-on: ubuntu-latest

    steps:
    # Github actions have Node and Yarn already set-up by default
    # It is not clear which versions these are, 
    # so it might be a good idea to specify them via an action like actions/setup-node@v4
    - uses: actions/checkout@v4
    - name: Install
      run: yarn
    - name: Unit tests
      run: yarn test
    - name: Build
      run: yarn build
    - name: Integration tests
      run: yarn test:e2e

    - name: JUnit Report Action
      uses: mikepenz/action-junit-report@v5.6.2
      with:
        report_paths: "**/reports/**/*.xml"
        fail_on_failure: false
